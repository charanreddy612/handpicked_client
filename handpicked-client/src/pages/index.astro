---
// src/pages/index.astro (branded Tailwind version)
// NOTE: Keeping imports, types, and variable names non-breaking.
import Base from "../layouts/Base.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import BannerSlider from "../components/BannerSlider.jsx";
import CouponRevealIsland from "../components/islands/CouponRevealIsland";
import CardStore from "../components/CardStore.astro";
import { api } from "../lib/api";

const pageMeta = {
  title: "HandPicked Deals | Verified Coupons & Discounts",
  description:
    "Verified coupons, real savings, no expired junk — handpicked by real humans.",
};

type Store = {
  id: string | number;
  name: string;
  slug: string;
  logo_url?: string | null;
  stats?: { active_coupons?: number };
};
type StoresResponse = { data: Store[]; meta: any };

type Coupon = {
  id: string | number;
  title?: string | null;
  code?: string | null;
  ends_at?: string | null;
  merchant_name?: string | null;
};
type CouponsResponse = { data: Coupon[]; meta: any };

let resp = null,
  cresp = null;

try {
  const [r, c] = await Promise.all([
    api.get<StoresResponse>(
      "/stores?limit=8&mode=homepage",
      {},
      { retries: 2, timeout: 8000 }
    ),
    api.get<CouponsResponse>(
      "/coupons?limit=8&mode=homepage",
      {},
      { retries: 2, timeout: 8000 }
    ),
  ]);

  resp = r;
  cresp = c;
} catch (err) {
  console.error("Landing fetch error", err);
  resp = { data: [], meta: {} };
  cresp = { data: [], meta: {} };
}

const stores = resp?.data || [];
const coupons = cresp?.data || [];
const meta = resp?.meta || {};
const cmeta = cresp?.meta || {};
---

<Base meta={pageMeta}>
  <Header />

  <main class="container mx-auto px-4 py-10">
    <!-- Hero -->
    <section class="mx-auto max-w-3xl text-center">
      <h1
        class="text-3xl md:text-4xl font-bold tracking-tight text-brand-primary"
      >
        Verified coupons, real savings, no expired junk — handpicked by real
        humans.
      </h1>
      <p class="mt-3 text-gray-400">
        Save on top brands with codes we test ourselves.
      </p>

      <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
        <a
          href="/coupons"
          class="inline-block px-5 py-2 rounded-md text-white bg-brand-primary hover:bg-brand-primary/90"
        >
          Browse Coupons
        </a>
        <a
          href="/stores"
          class="inline-block px-5 py-2 rounded-md border border-brand-accent text-brand-secondary hover:bg-brand-secondary/5"
        >
          Explore Stores
        </a>
      </div>
    </section>

    <!-- Banner -->
    <div class="mt-8">
      <BannerSlider client:visible />
    </div>

    <!-- Stores -->
    <div class="mt-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-brand-secondary">Stores</h2>
        <a
          href="/stores"
          class="text-sm text-brand-secondary hover:underline"
          aria-label="View all stores">View all →</a
        >
      </div>

      <section>
        {
          stores.length > 0 ? (
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
              {stores.map((store) => (
                <div
                  class="rounded-md bg-white/5 p-3 transition-shadow hover:shadow-store-card"
                  style="border-top-width: 3px; border-top-style: solid; border-top-color: transparent;"
                >
                  {/* Keep CardStore component exactly as-is */}
                  <CardStore store={store} />
                </div>
              ))}
            </div>
          ) : (
            <p class="text-gray-500">No stores found.</p>
          )
        }
      </section>
    </div>

    <!-- Coupons -->
    <div class="mt-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-brand-secondary">Coupons</h2>
        <a
          href="/coupons"
          class="text-sm text-brand-secondary hover:underline"
          aria-label="Explore more coupons">Explore more →</a
        >
      </div>

      <section>
        {
          coupons.length > 0 ? (
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
              {coupons.map((c) => (
                <div
                  class="rounded-md bg-white/3 p-3 transition-shadow hover:shadow-store-card card-accent-top"
                  style="border-top-width: 3px; border-top-style: solid; "
                >
                  <CouponRevealIsland
                    client:idle
                    coupon={c}
                    storeSlug={c.merchant_name}
                  />
                </div>
              ))}
            </div>
          ) : (
            <p class="text-gray-500">
              No coupons available right now. Check back soon.
            </p>
          )
        }
      </section>
    </div>

    <!-- Testimonials -->
    <section class="mt-16">
      <h3 class="text-xl font-semibold mb-4 text-brand-primary">
        What people say
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-4 text-sm text-gray-200 bg-white/2 rounded">
          "Testimonial 1 — The HandPicked experience was amazing and saved me
          real money!" — User 1
        </div>
        <div class="card p-4 text-sm text-gray-200 bg-white/2 rounded">
          "Testimonial 2 — The HandPicked experience was amazing and saved me
          real money!" — User 2
        </div>
        <div class="card p-4 text-sm text-gray-200 bg-white/2 rounded">
          "Testimonial 3 — The HandPicked experience was amazing and saved me
          real money!" — User 3
        </div>
      </div>
    </section>

    <!-- Newsletter / CTA -->
    <section
      class="mt-16 rounded-lg bg-brand-dark text-white py-10 px-6 text-center"
    >
      <h4 class="text-xl font-semibold">
        Subscribe and stay ahead — no spam, ever.
      </h4>
      <p class="mt-2 text-gray-300">Get the best deals delivered weekly.</p>

      <form
        class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-3 max-w-xl mx-auto"
      >
        <input
          type="email"
          name="email"
          placeholder="you@domain.com"
          class="w-full sm:flex-1 rounded-md px-4 py-2 text-black"
          aria-label="Email address"
        />
        <button
          type="submit"
          class="px-4 py-2 rounded-md bg-brand-primary text-white"
        >
          Subscribe
        </button>
      </form>
    </section>
  </main>

  <Footer />
</Base>
