---
import Base from "../layouts/Base.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import BannerSlider from "../components/BannerSlider.jsx";
import CouponRevealIsland from "../components/islands/CouponRevealIsland";
import CardStore from "../components/CardStore.astro";
import Pagination from "../components/Pagination.astro";
import { api } from "../lib/api";

const pageMeta = {
  title: "HandPicked Deals | Verified Coupons & Discounts",
  description:
    "Verified coupons, real savings, no expired junk — handpicked by real humans.",
};

type Store = {
  id: string | number;
  name: string;
  slug: string;
  logo_url?: string | null;
  stats?: { active_coupons?: number };
};

type StoresResponse = {
  data: Store[];
  meta: {
    page?: number;
    limit?: number;
    total?: number;
    canonical?: string;
    prev?: string | null;
    next?: string | null;
    total_pages?: number;
    title?: string;
    description?: string;
  };
};

type Coupon = {
  id: string | number;
  title?: string | null;
  code?: string | null;
  ends_at?: string | null;
  merchant_name?: string | null;
};

type CouponsResponse = {
  data: Coupon[];
  meta: {
    page?: number;
    limit?: number;
    total?: number;
    canonical?: string;
    prev?: string | null;
    next?: string | null;
    total_pages?: number;
    jsonld?: any;
    title?: string;
    description?: string;
  };
};

let resp = null,
  cresp = null;
try {
  const [r, c] = await Promise.allSettled([
    api.get<StoresResponse>("/stores?limit=8"),
    api.get<CouponsResponse>("/coupons?limit=8"),
  ]);
  if (r.status === "fulfilled") resp = r.value;
  if (c.status === "fulfilled") cresp = c.value;
} catch (err) {
  console.error("Landing fetch error", err);
}
const stores = resp?.data || [];
const meta = resp?.meta || {};
const coupons = cresp?.data || [];
const cmeta = cresp?.meta || {};
---

<Base meta={pageMeta}>
  <Header />
  <main class="container py-10">
    <section class="text-center" style="max-width: 48rem; margin: 0 auto;">
      <h1 class="text-3xl md:text-4xl font-bold tracking-tight">
        Verified coupons, real savings, no expired junk — handpicked by real
        humans.
      </h1>
      <p class="mt-3" style="color: var(--color-muted);">
        Save on top brands with codes we test ourselves.
      </p>
      <!-- <div
        class="mt-6"
        style="display: flex; gap: 0.75rem; justify-content: center;"
      >
        <a href="/coupons" class="btn btn-primary">Browse Coupons</a>
        <a href="/stores" class="btn btn-outline">Explore Stores</a>
      </div> -->
    </section>
    <BannerSlider client:visible />
    <h1 class="text-2xl font-bold mb-6">Stores</h1>
    <!-- <section
      class="mt-12"
      style="display: grid; gap: 1rem; grid-template-columns: repeat(12, minmax(0,1fr));"
    > -->
    <section class="text-center" style="max-width: 48rem; margin: 0 auto;">
      {
        stores.length > 0 ? (
          <div class="grid-3-equal gap-6">
            {stores.map((store) => (
              <CardStore store={store} />
            ))}
          </div>
        ) : (
          <p class="text-gray-600">No stores found.</p>
        )
      }

      <Pagination
        prev={meta.prev}
        next={meta.next}
        total_pages={meta.total_pages}
      />
    </section>
    <h1 class="text-2xl font-bold mb-6">Coupons</h1>
    <!-- <section
      class="mt-16"
      style="display: grid; gap: 1.5rem; grid-template-columns: repeat(12, minmax(0,1fr));"
    > -->
    <section class="text-center" style="max-width: 48rem; margin: 0 auto;">
      {
        coupons.length > 0 ? (
          <div class="grid-2-equal">
            {coupons.map((c) => (
              // <CardCoupon coupon={c} />
              <CouponRevealIsland
                client:idle
                coupon={c}
                storeSlug={c.merchant_name}
              />
            ))}
          </div>
        ) : (
          <p class="text-gray-600">
            No coupons available right now. Check back soon.
          </p>
        )
      }

      <Pagination
        prev={cmeta.prev}
        next={cmeta.next}
        total_pages={cmeta.total_pages}
      />
    </section>

    <section class="mt-16">
      <h2 class="text-xl font-semibold mb-4">What people say</h2>
      <div
        style="display: grid; gap: 1rem; grid-template-columns: repeat(12, minmax(0,1fr));"
      >
        <div
          class="card p-4 text-sm"
          style="grid-column: span 12; @media(min-width:768px){grid-column: span 4}; color: var(--color-text);"
        >
          "Testimonial 1 — The HandPicked experience was amazing and saved me
          real money!" — User 1
        </div>
        <div
          class="card p-4 text-sm"
          style="grid-column: span 12; @media(min-width:768px){grid-column: span 4}; color: var(--color-text);"
        >
          "Testimonial 2 — The HandPicked experience was amazing and saved me
          real money!" — User 2
        </div>
        <div
          class="card p-4 text-sm"
          style="grid-column: span 12; @media(min-width:768px){grid-column: span 4}; color: var(--color-text);"
        >
          "Testimonial 3 — The HandPicked experience was amazing and saved me
          real money!" — User 3
        </div>
      </div>
    </section>

    <section class="mt-16 card p-6 text-center">
      <h2 class="text-xl font-semibold">
        Subscribe and stay ahead — no spam, ever.
      </h2>
      <!-- TODO: integrate actual newsletter form -->
    </section>
  </main>
  <Footer />
</Base>
