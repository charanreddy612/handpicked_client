---
// src/pages/index.astro (branded Tailwind version)
// NOTE: Keeping imports, types, and variable names non-breaking.
import Base from "../layouts/Base.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import BannerSlider from "../components/BannerSlider.jsx";
import CouponRevealIsland from "../components/islands/CouponRevealIsland.astro";
import CardStore from "../components/CardStore.astro";
import { api } from "../lib/api";
import LandingSubscribeIsland from "../components/islands/LandingSubscribeIsland.jsx";

const pageMeta = {
  title: "Saving Harbor | Verified Coupons & Discounts",
  description:
    "Verified coupons, real savings, no expired junk — handpicked by real humans.",
};

type Store = {
  id: string | number;
  name: string;
  slug: string;
  logo_url?: string | null;
  stats?: { active_coupons?: number };
};
type StoresResponse = { data: Store[]; meta: any };

type Coupon = {
  id: string | number;
  title?: string | null;
  code?: string | null;
  ends_at?: string | null;
  merchant_name?: string | null;
};
type CouponsResponse = { data: Coupon[]; meta: any };

let resp = null,
  cresp = null;

try {
  const [r, c] = await Promise.all([
    api.get<StoresResponse>(
      "/stores?limit=8&mode=homepage",
      {},
      { retries: 2, timeout: 8000 }
    ),
    api.get<CouponsResponse>(
      "/coupons?limit=8&mode=homepage",
      {},
      { retries: 2, timeout: 8000 }
    ),
  ]);

  resp = r;
  cresp = c;
} catch (err) {
  console.error("Landing fetch error", err);
  resp = { data: [], meta: {} };
  cresp = { data: [], meta: {} };
}

const stores = resp?.data || [];
const coupons = cresp?.data || [];
const meta = resp?.meta || {};
const cmeta = cresp?.meta || {};
---

<Base meta={pageMeta}>
  <Header />

  <main class="container mx-auto px-4 py-10">
    <!-- Hero -->
    <section class="mx-auto max-w-3xl text-center">
      <h1
        class="text-3xl md:text-4xl font-bold tracking-tight text-brand-primary"
      >
        Verified coupons, real savings, no expired junk — handpicked by real
        humans.
      </h1>
      <p class="mt-3 text-gray-400">
        Save on top brands with codes we test ourselves.
      </p>

      <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
        <a href="/coupons" class="btn btn-primary"> Browse Coupons </a>
        <a href="/stores" class="btn btn-outline"> Explore Stores </a>
      </div>
    </section>

    <!-- Banner -->
    <div class="mt-8">
      <BannerSlider client:visible />
    </div>

    <!-- Stores -->
    <div class="mt-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-brand-secondary">Stores</h2>
        <a href="/stores" class="btn btn-outline" aria-label="View all stores"
          >View all →</a
        >
      </div>

      <section>
        {
          stores.length > 0 ? (
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
              {stores.map((store) => (
                <div
                  class="rounded-md bg-white/5 p-3 transition-shadow hover:shadow-store-card"
                  style="border-top-width: 3px; border-top-style: solid; border-top-color: transparent;"
                >
                  {/* Keep CardStore component exactly as-is */}
                  <CardStore store={store} />
                </div>
              ))}
            </div>
          ) : (
            <p class="text-gray-500">No stores found.</p>
          )
        }
      </section>
    </div>

    <!-- Coupons -->
    <div class="mt-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-brand-secondary">Coupons</h2>
        <a
          href="/coupons"
          class="btn btn-outline"
          aria-label="Explore more coupons"
        >
          Explore more →
        </a>
      </div>

      <section>
        {
          coupons.length > 0 ? (
            /* NOTE: added items-stretch so grid children stretch vertically */
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 items-stretch">
              {coupons.map((c) => (
                /* NOTE: each grid cell must be full-height so the inner card can h-full */
                <div
                  class="h-full rounded-md bg-white/3 p-3 transition-shadow hover:shadow-store-card card-accent-top"
                  style="border-top-width: 3px; border-top-style: solid;"
                >
                  {/* CouponRevealIsland injects the SSR markup; that markup must render h-full
                  — we already updated renderCouponCardHtml to wrap with w-full h-full */}
                  <CouponRevealIsland
                    client:idle
                    coupon={c}
                    storeSlug={c.merchant_name}
                  />
                </div>
              ))}
            </div>
          ) : (
            <p class="text-gray-500">
              No coupons available right now. Check back soon.
            </p>
          )
        }
      </section>
    </div>

    <!-- Testimonials -->
    <section class="mt-16">
      <h2 class="text-xl font-semibold mb-6 text-gray-900">What people say</h2>

      <div class="grid gap-6 md:grid-cols-3">
        <div
          class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 text-sm text-gray-700"
        >
          "Testimonial 1 — The Saving Harbor experience was amazing and saved me
          real money!" — User 1
        </div>

        <div
          class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 text-sm text-gray-700"
        >
          "Testimonial 2 — The Saving Harbor experience was amazing and saved me
          real money!" — User 2
        </div>

        <div
          class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 text-sm text-gray-700"
        >
          "Testimonial 3 — The Saving Harbor experience was amazing and saved me
          real money!" — User 3
        </div>
      </div>
    </section>

    <!-- Newsletter / CTA -->
    <section
      class="mt-16 bg-brand-primary text-white rounded-xl p-6 text-center shadow-md"
    >
      <h2 class="text-xl font-semibold">
        Subscribe and stay ahead — no spam, ever.
      </h2>
      <p class="mt-2 opacity-90">Get the best deals delivered weekly.</p>
      <LandingSubscribeIsland client:load />
    </section>
  </main>

  <Footer />
</Base>
