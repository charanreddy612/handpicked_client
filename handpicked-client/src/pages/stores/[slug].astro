---
import { Astro } from "astro";

// Environment variable
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL;

// Extract slug from route params
const { slug } = Astro.params;

// Defensive fetch
let store = null;
try {
  const res = await fetch(`${API_BASE}/stores/${slug}`, {
    headers: { "Accept": "application/json" },
    cache: "no-store",
  });
  if (res.ok) {
    const json = await res.json();
    store = json?.data ?? null;
  }
} catch (e) {
  store = null;
}

// Fallback data
const fallback = {
  name: slug,
  logo_url: "/fallback-logo.svg",
  category_names: ["General"],
  about_html: "<p>Coupons and promo codes updated regularly.</p>",
  last_updated: new Date().toISOString(),
  stats: { active_coupons: 0 },
  coupons: { items: [], total_pages: 1 },
  breadcrumbs: [
    { name: "Home", url: "/" },
    { name: "Stores", url: "/stores" },
    { name: slug, url: `/stores/${slug}` },
  ],
  seo_title: `${slug} Coupons & Promo Codes`,
  seo_description: `Find the latest ${slug} coupons & deals.`,
  canonical: `https://yoursite.com/stores/${slug}`,
  rating_value: 4.5,
  rating_count: 100,
  brand_site: "#",
  hero_image: "/fallback-hero.webp",
};

const data = store ?? fallback;

// SEO metadata
const pageTitle = data.seo_title || `${data.name} Coupons & Promo Codes | ${new Date().toLocaleString("default",{month:"long",year:"numeric"})}`;
const pageDesc = data.seo_description || `Save with the latest ${data.name} coupons, promo codes & deals.`;
const canonical = data.canonical || `https://yoursite.com/stores/${data.slug ?? slug}`;
const ogImage = data.hero_image || data.logo_url;

// JSON-LD
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": pageTitle,
  "description": pageDesc,
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": data.breadcrumbs.map((b, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "name": b.name,
      "item": `https://yoursite.com${b.url}`,
    })),
  },
  "brand": {
    "@type": "Brand",
    "name": data.name,
    "logo": data.logo_url,
    "url": data.brand_site,
    ...(data.rating_value && data.rating_count
      ? {
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": data.rating_value,
            "ratingCount": data.rating_count,
          },
        }
      : {}),
  },
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": `${data.name} Coupons`,
    "itemListElement": data.coupons.items.map((c) => ({
      "@type": "Coupon",
      "name": c.title,
      "discountCode": c.code || undefined,
      "description": c.discount_text,
      "validThrough": c.ends_at || undefined,
    })),
  },
};
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDesc} />
    <link rel="canonical" href={canonical} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDesc} />
    <meta property="og:image" content={ogImage} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDesc} />
    <meta name="twitter:image" content={ogImage} />
    <script type="application/ld+json">
      {JSON.stringify(jsonLd)}
    </script>
  </head>
  <body class="bg-white text-gray-900 font-sans">
    <!-- Breadcrumbs -->
    <nav aria-label="Breadcrumb" class="p-4 text-sm">
      <ol class="flex flex-wrap gap-2">
        {data.breadcrumbs.map((b, i) => (
          <li>
            <a href={b.url} class="text-blue-600 hover:underline">{b.name}</a>
            {i < data.breadcrumbs.length - 1 ? "â€º" : ""}
          </li>
        ))}
      </ol>
    </nav>

    <!-- Hero -->
    <header class="p-4 md:p-8 text-center">
      <img
        src={data.logo_url}
        alt={`${data.name} logo`}
        width="120"
        height="120"
        loading="lazy"
        decoding="async"
        class="mx-auto mb-4 rounded"
      />
      <h1 class="text-2xl md:text-4xl font-bold">{data.name} Coupons & Promo Codes</h1>
      <p class="text-gray-600">{data.category_names.join(", ")}</p>
      <p class="mt-2 text-green-700 font-semibold">{data.stats.active_coupons} Active Coupons</p>
    </header>

    <!-- Quick Answers -->
    <section class="max-w-3xl mx-auto p-4 grid gap-2 border rounded-xl shadow-sm bg-gray-50">
      <h2 class="sr-only">Quick Answers</h2>
      <p><strong>Best code today:</strong> {data.coupons.items[0]?.discount_text || "Check deals"}</p>
      <p><strong>Updated:</strong> {new Date(data.last_updated).toLocaleDateString()}</p>
      <p><strong>Categories:</strong> {data.category_names.join(", ")}</p>
      <p><strong>Status:</strong> {data.stats.active_coupons > 0 ? "Active" : "Updating"}</p>
    </section>

    <!-- About -->
    <section class="max-w-3xl mx-auto p-4 prose">
      <h2>About {data.name}</h2>
      <div set:html={data.about_html}></div>
    </section>

    <!-- Coupons -->
    <section class="max-w-3xl mx-auto p-4">
      <h2 class="text-xl font-bold mb-4">Available Coupons</h2>
      <ul class="space-y-4">
        {data.coupons.items.map((c) => (
          <li class="p-4 border rounded-lg shadow-sm bg-white">
            <h3 class="font-semibold">{c.title}</h3>
            <p class="text-green-700">{c.discount_text}</p>
            {c.ends_at && (
              <p class="text-sm text-gray-500">Expires {new Date(c.ends_at).toLocaleDateString()}</p>
            )}
            <button
              class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              aria-label={`Reveal ${c.code ? "coupon code" : "deal"} for ${c.title}`}
              onClick={`navigator.clipboard.writeText('${c.code ?? ""}')`}
              rel="nofollow sponsored noopener"
            >
              {c.code ? "SHOW CODE" : "GET DEAL"}
            </button>
          </li>
        ))}
      </ul>

      <!-- Pagination -->
      <div class="flex justify-between mt-6">
        {data.coupons.prev && <a href={data.coupons.prev} class="text-blue-600 hover:underline">Previous</a>}
        {data.coupons.next && <a href={data.coupons.next} class="text-blue-600 hover:underline">Next</a>}
      </div>
    </section>

    <!-- Trust box -->
    <aside class="max-w-3xl mx-auto p-4 mt-8 border rounded-lg bg-gray-50">
      <h2 class="text-lg font-bold mb-2">Why trust our coupons?</h2>
      <ul class="list-disc ml-6 text-sm">
        <li>Verified codes and deals updated regularly.</li>
        <li>Safe outbound links (nofollow, sponsored, noopener).</li>
        <li>Expiry dates clearly displayed.</li>
        <li>Last updated {new Date(data.last_updated).toLocaleDateString()}.</li>
      </ul>
    </aside>
  </body>
</html>
