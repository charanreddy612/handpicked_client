---
// src/pages/blogs/[slug].astro (replace)
import Base from "../../layouts/Base.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import { api } from "../../lib/api";
import DOMPurify from "isomorphic-dompurify";

type BlogDetail = {
  id: string | number;
  slug: string;
  title: string;
  hero_image_url?: string | null;
  category?: string | null;
  created_at?: string | null;
  updated_at?: string | null;
  author?: {
    name?: string | null;
    role?: string | null;
    avatar_url?: string | null;
    sameAs?: string[];
  } | null;
  breadcrumbs?: { name: string; url: string }[];
  content_html?: string | null;
};

type BlogDetailResponse = {
  data: BlogDetail | null;
  meta?: {
    canonical?: string;
    jsonld?: any;
    title?: string;
    description?: string;
  };
};

const { slug } = Astro.params as { slug: string };

let resp: BlogDetailResponse | null = null;
try {
  // retries + timeout to reduce transient failures
  resp = await api.get<BlogDetailResponse>(
    `/blogs/${slug}`,
    {},
    { retries: 2, timeout: 8000 }
  );
} catch (e) {
  console.error("Error fetching blog detail:", e);
  // safe fallback shape so UI bindings don't break
  resp = {
    data: null,
    meta: {
      title: "Blog - HandPicked",
      description: "Blog temporarily unavailable.",
      canonical: undefined,
      jsonld: undefined,
    },
  };
}

const post = resp?.data || null;
const meta = resp?.meta || {};
const pageTitle =
  meta.title ||
  (post?.title ? `${post.title} - HandPicked` : "Blog - HandPicked");
const pageDesc = meta.description || "HandPicked editorial.";
const canonical = meta.canonical;
const jsonld = meta.jsonld;

// sanitize body_html once for safe rendering
const safeBodyHtml = post?.content_html
  ? DOMPurify.sanitize(post.content_html)
  : null;
---

<Base meta={{ title: pageTitle, description: pageDesc, canonical, jsonld }}>
  <Header />
  <main class="container py-10">
    {
      post ? (
        <>
          <Breadcrumbs breadcrumbs={post.breadcrumbs} />
          <header class="mt-4">
            <h1 class="text-3xl font-bold tracking-tight">{post.title}</h1>
            <div class="mt-2 text-sm text-gray-600 flex items-center gap-2">
              {post.category && <span>{post.category}</span>}
              {post.created_at && (
                <span>- {new Date(post.created_at).toLocaleDateString()}</span>
              )}
              {post.updated_at && (
                <span>
                  - Updated {new Date(post.updated_at).toLocaleDateString()}
                </span>
              )}
            </div>

            {post.author && (
              <div class="mt-4 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center">
                  {post.author.avatar_url ? (
                    <img
                      src={post.author.avatar_url}
                      alt={post.author.name || "Author"}
                      width="40"
                      height="40"
                      class="object-cover"
                      loading="lazy"
                    />
                  ) : (
                    <div class="text-[10px] text-gray-400">Author</div>
                  )}
                </div>
                <div class="text-sm">
                  <div class="font-medium">
                    {post.author.name || "Editorial Team"}
                  </div>
                  {post.author.role && (
                    <div class="text-gray-600">{post.author.role}</div>
                  )}
                </div>
              </div>
            )}
          </header>

          {post.hero_image_url && (
            <figure class="mt-6">
              <img
                src={post.hero_image_url}
                alt={post.title}
                class="w-full h-auto rounded-lg border"
                loading="lazy"
              />
            </figure>
          )}

          {safeBodyHtml ? (
            <article class="prose max-w-none mt-8">
              <div set:html={safeBodyHtml} />
            </article>
          ) : (
            <p class="mt-8 text-gray-600">This article has no content.</p>
          )}
        </>
      ) : (
        <section class="py-20 text-center">
          <h1 class="text-2xl font-bold">Post not found</h1>
          <p class="text-gray-600 mt-2">
            Please check the URL or browse all posts.
          </p>
          <div class="mt-4">
            <a href="/blog" class="btn btn-outline">
              Back to Blog
            </a>
          </div>
        </section>
      )
    }
  </main>
  <Footer />
</Base>
